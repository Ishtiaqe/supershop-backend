// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  OWNER
  EMPLOYEE
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum SaleType {
  POS
  ONLINE
  WHOLESALE
}

enum PaymentMethod {
  CASH
  CARD
  MOBILE_PAYMENT
  OTHER
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum ProductType {
  GENERAL
  MEDICINE
}

// Users table - stores all users across all tenants
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  fullName  String
  phone     String?
  role      UserRole @default(EMPLOYEE)
  tenantId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant        Tenant?         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sales         Sale[]
  refreshTokens RefreshToken[]
  pushSubscriptions PushSubscription[]

  @@index([email])
  @@index([tenantId])
  @@map("users")
}

// Refresh tokens for JWT authentication
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// Push subscriptions for web notifications
model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique
  keys      Json     // { p256dh: string, auth: string }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

// Tenants table - each tenant is a separate business/store
model Tenant {
  id                 String        @id @default(uuid())
  name               String
  registrationNumber String?       @unique
  addressStreet      String?
  addressCity        String?
  addressZone        String?
  latitude           Float?
  longitude          Float?
  status             TenantStatus  @default(ACTIVE)
  preferences        Json?         // { allowOnlineSales, lowStockThreshold, contactEmail }
  theme              Json?         // { primaryColor, secondaryColor }
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  users             User[]
  inventoryItems    InventoryItem[]
  sales             Sale[]
  restockReceipts   RestockReceipt[]

  @@index([status])
  @@map("tenants")
}

// Master product catalog - shared across all tenants
model Category {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@map("categories")
}

model Brand {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@map("brands")
}

model Supplier {
  id            String   @id @default(uuid())
  name          String
  contactPerson String?
  phone         String?
  email         String?
  address       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  restockReceipts RestockReceipt[]

  @@map("suppliers")
}

// Master products - generic product information
model Product {
  id               String      @id @default(uuid())
  name             String
  description      String?
  productType      ProductType @default(GENERAL)
  genericName      String?     // For medicines - the generic/chemical name
  manufacturerName String?     // Manufacturer/brand company name
  brandId          String?
  categoryId       String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  brand    Brand?    @relation(fields: [brandId], references: [id], onDelete: SetNull)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  variants ProductVariant[]

  @@index([name])
  @@index([brandId])
  @@index([categoryId])
  @@index([productType])
  @@map("products")
}

// Product variants (SKUs) - specific sellable units
model ProductVariant {
  id          String   @id @default(uuid())
  productId   String
  variantName String // e.g., "1L Carton", "500ml Bottle"
  sku         String   @unique
  retailPrice Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventoryItems InventoryItem[]

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

// Inventory items - tenant-specific stock
model InventoryItem {
  id              String    @id @default(uuid())
  tenantId        String
  variantId       String?   // nullable for ad-hoc items
  itemName        String?   // for ad-hoc items without catalog entry
  quantity        Int       @default(0)
  purchasePrice   Float
  retailPrice     Float
  maxDiscountRate Float     @default(0)
  expiryDate      DateTime?
  mfgDate         DateTime?
  batchNo         String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  saleItems SaleItem[]

  @@index([tenantId])
  @@index([variantId])
  @@index([expiryDate])
  @@index([quantity])
  @@map("inventory_items")
}

// Restock receipts for batch inventory additions
model RestockReceipt {
  id            String   @id @default(uuid())
  tenantId      String
  receiptNumber String
  supplierId    String?
  notes         String?
  createdAt     DateTime @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([receiptNumber])
  @@map("restock_receipts")
}

// Sales transactions
model Sale {
  id            String         @id @default(uuid())
  tenantId      String
  employeeId    String
  receiptNumber String         @unique
  saleTime      DateTime       @default(now())
  totalAmount   Float
  totalProfit   Float
  customerName  String?
  customerPhone String?
  saleType      SaleType       @default(POS)
  paymentMethod PaymentMethod  @default(CASH)
  discountType  DiscountType?
  discountValue Float?         @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee User     @relation(fields: [employeeId], references: [id])
  items    SaleItem[]

  @@index([tenantId])
  @@index([saleTime])
  @@index([receiptNumber])
  @@map("sales")
}

// Individual items within a sale
model SaleItem {
  id          String   @id @default(uuid())
  saleId      String
  inventoryId String
  quantity    Int
  unitPrice   Float
  subtotal    Float
  createdAt   DateTime @default(now())

  sale      Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  inventory InventoryItem @relation(fields: [inventoryId], references: [id])

  @@index([saleId])
  @@index([inventoryId])
  @@map("sale_items")
}
